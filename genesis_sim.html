<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GÃ‰NESIS LAB: 8-BIT RESEARCH EDITION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script>
        MathJax = {
            tex: { inlineMath: [['$','$'],['\\(','\\)']], displayMath: [['$$','$$'],['\\[','\\]']] },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --g0: #bf00ff;
            --g1: #00f5ff;
            --cpu: #00ff88;
            --alt: #ff0055;
            --gld: #ffd700;
            --bg:  #050508;
            --grd: rgba(0,245,255,0.07);
        }
        *{ box-sizing:border-box; }
        body{
            font-family:'Press Start 2P',cursive;
            background:var(--bg); color:#fff;
            margin:0; height:100vh;
            display:flex; flex-direction:column; overflow:hidden;
        }
        .crt{
            position:fixed; inset:0;
            background:
                linear-gradient(rgba(18,16,16,0) 50%,rgba(0,0,0,.22) 50%),
                linear-gradient(90deg,rgba(255,0,0,.04),rgba(0,255,0,.02),rgba(0,0,255,.04));
            background-size:100% 4px, 3px 100%;
            pointer-events:none; z-index:9999;
        }
        .grid-bg{
            background-image:
                linear-gradient(var(--grd) 1px,transparent 1px),
                linear-gradient(90deg,var(--grd) 1px,transparent 1px);
            background-size:40px 40px;
        }
        .mono{ font-family:'JetBrains Mono',monospace; }
        .hbar{ height:10px; background:#111; border:1px solid #333; overflow:hidden; }
        .hbar-fill{ height:100%; background:linear-gradient(90deg,var(--alt),var(--gld),var(--cpu)); transition:width 1.5s ease; }
        .btn{
            background:#0a0a0f; border:3px solid var(--g0); color:var(--g0);
            box-shadow:inset -3px -3px 0 rgba(0,0,0,.6), 0 0 12px rgba(191,0,255,.25);
            cursor:pointer; transition:.1s;
            font-family:'Press Start 2P',cursive;
        }
        .btn:active:not(:disabled){ transform:translate(2px,2px); color:var(--g1); border-color:var(--g1); }
        .btn:disabled{ border-color:#333; color:#444; cursor:not-allowed; box-shadow:none; }
        .zone-lbl{ position:absolute; bottom:4px; font-size:7px; opacity:.35; white-space:nowrap; }
        /* dark-panel label â€” fixes text visibility over animations */
        .lbl{
            background:rgba(0,0,0,.82);
            padding:2px 5px;
            border:1px solid rgba(255,255,255,.08);
            font-size:6px;
            white-space:nowrap;
            pointer-events:none;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â• KEYFRAMES â•â•â•â•â•â•â•â•â•â•â•â• */
        @keyframes brainPulse{
            0%,100%{ transform:scale(1); filter:brightness(1); }
            50%{ transform:scale(1.1); filter:brightness(1.5) drop-shadow(0 0 20px var(--g0)); }
        }
        @keyframes liquidRise{
            0%,100%{ height:56%; }
            50%{ height:63%; }
        }
        @keyframes orbArc{
            0%  { left:26%; top:42%; opacity:1; transform:scale(1); }
            50% { top:30%; opacity:1; }
            85% { left:68%; top:62%; opacity:1; transform:scale(.9); }
            100%{ left:70%; top:63%; opacity:0; transform:scale(.2); }
        }
        @keyframes trashAway{
            0%{ opacity:.6; }
            100%{ transform:translateY(-55px) rotate(50deg); opacity:0; }
        }
        @keyframes robotRun{
            0%  { left:-8%; opacity:1; }
            78% { left:65%; opacity:1; }
            88% { left:67%; opacity:0; }
            89% { left:-10%; opacity:0; }
            100%{ left:-8%;  opacity:1; }
        }
        @keyframes mechaIdle{
            0%,100%{ filter:brightness(.6) hue-rotate(200deg); }
            50%{ filter:brightness(.72) hue-rotate(200deg); }
        }
        @keyframes mechaAwaken{
            0%  { filter:brightness(.6) hue-rotate(200deg); transform:translateY(0); }
            60% { filter:brightness(1.7) hue-rotate(20deg);  transform:translateY(-12px); }
            100%{ filter:brightness(1.2) hue-rotate(0deg);   transform:translateY(-20px); }
        }
        @keyframes droneHover{
            0%,100%{ transform:translateY(0) rotate(-2deg); }
            50%{ transform:translateY(-8px) rotate(2deg); }
        }
        @keyframes propSpin{
            0%{ transform:scaleX(1); }
            50%{ transform:scaleX(0); }
            100%{ transform:scaleX(-1); }
        }
        @keyframes conveyorScroll{
            0%{ background-position:0 0; }
            100%{ background-position:-40px 0; }
        }
        @keyframes cloneSlide{
            0%  { left:-12%; }
            100%{ left:112%; }
        }
        @keyframes ufoHover{
            0%,100%{ transform:translateX(-50%) translateY(0); }
            50%{ transform:translateX(-50%) translateY(-8px); }
        }
        @keyframes glitch{
            0%  { transform:translate(0);        filter:none; }
            20% { transform:translate(-3px,2px);  filter:hue-rotate(90deg) brightness(1.6); }
            40% { transform:translate(3px,-2px);  filter:hue-rotate(180deg); }
            60% { transform:translate(-2px,-2px); filter:hue-rotate(270deg) brightness(1.6); }
            80% { transform:translate(2px,3px);   filter:hue-rotate(360deg); }
            100%{ transform:translate(0);         filter:none; }
        }
        .glitching{ animation:glitch .35s infinite !important; }
        @keyframes weightLift{
            0%,100%{ transform:translateY(0); }
            50%{ transform:translateY(-16px); }
        }
        @keyframes sweatDrop{
            0%{ opacity:1; top:0; }
            100%{ opacity:0; top:20px; }
        }
        @keyframes rankFlash{
            0%,100%{ opacity:0; transform:scale(.5) rotate(-8deg); }
            50%{ opacity:1; transform:scale(1.2) rotate(4deg); }
        }
        @keyframes sawSpin{
            0%{ transform:rotate(0deg); }
            100%{ transform:rotate(360deg); }
        }
        @keyframes magnetBob{
            0%,100%{ transform:translateX(-50%) translateY(0); }
            50%{ transform:translateX(-50%) translateY(10px); }
        }
        @keyframes fusionFlash{
            0%  { opacity:0; transform:scale(0); }
            40% { opacity:1; transform:scale(1.8); }
            100%{ opacity:0; transform:scale(.6); }
        }
        @keyframes speedLine{
            0%  { right:-10%; opacity:1; }
            100%{ right:110%; opacity:0; }
        }
        @keyframes deployPulse{
            0%,100%{ opacity:1; text-shadow:0 0 20px var(--cpu),0 0 40px var(--cpu); }
            50%{ opacity:.6; text-shadow:0 0 8px var(--cpu); }
        }
        @keyframes hwFlash{
            0%,100%{ background:var(--cpu); color:#000; }
            50%{ background:#fff; color:#000; }
        }
        @keyframes slideInTop{
            0%{ transform:translateY(-12px); opacity:0; }
            100%{ transform:translateY(0); opacity:1; }
        }
        @keyframes auraGlow{
            0%,100%{ box-shadow:0 0 10px currentColor; }
            50%{ box-shadow:0 0 35px currentColor, 0 0 70px currentColor; }
        }
        @keyframes superIdle{
            0%,100%{ transform:translateX(-50%) translateY(0) rotate(0deg); filter:brightness(1); }
            50%{ transform:translateX(-50%) translateY(-6px) rotate(2deg); filter:brightness(1.5) drop-shadow(0 0 22px var(--gld)); }
        }
        @keyframes robotZoom{
            0%  { left:-18%; }
            100%{ left:115%; }
        }
        @keyframes scanLine{
            0%  { top:0; opacity:1; }
            100%{ top:100%; opacity:.3; }
        }
        @keyframes basketFlash{
            0%,100%{ background:transparent; box-shadow:none; }
            50%{ background:rgba(255,255,255,.4); box-shadow:0 0 15px #fff; }
        }
        @keyframes orbCatch{
            0%  { opacity:1; transform:scale(1); }
            100%{ opacity:0; transform:scale(2); }
        }
    </style>
</head>
<body>
    <div class="crt"></div>

    <!-- HUD -->
    <header class="flex-shrink-0 border-b-4 z-10" style="border-color:var(--g1);">
        <div class="flex items-center gap-3 px-3 py-2">
            <div class="flex-shrink-0">
                <div style="font-size:13px;color:var(--g1);letter-spacing:1px;">GÃ‰NESIS_LAB</div>
                <div style="font-size:7px;color:var(--g0);margin-top:2px;">NV_DUAL_RTX5090 // RESEARCH TIER</div>
            </div>
            <div class="flex-grow flex items-center gap-4">
                <div style="font-size:7px;color:#555;">SYS_HEALTH:</div>
                <div class="hbar flex-grow" style="max-width:120px;">
                    <div id="health-fill" class="hbar-fill" style="width:40%"></div>
                </div>
                <div style="font-size:7px;display:flex;gap:12px;">
                    <span style="color:#555;">VRAM:</span><span id="h-vram">48GB</span>
                    <span style="color:#555;">GEN:</span><span id="h-gen" style="color:var(--cpu);">00</span>
                    <span style="color:#555;">PPL:</span><span id="h-ppl" style="color:var(--alt);">âˆ</span>
                    <span style="color:#555;">FIT:</span><span id="h-fit" style="color:var(--cpu);">0.000</span>
                </div>
            </div>
            <div id="stage-lbl" style="font-size:8px;color:var(--gld);min-width:150px;text-align:right;">STANDBY</div>
        </div>
    </header>

    <!-- MAIN -->
    <div class="flex flex-grow gap-2 p-2 z-10" style="min-height:0;overflow:hidden;">

        <!-- LEFT Telemetry -->
        <div class="flex-shrink-0 flex flex-col gap-2" style="width:148px;">
            <div class="flex flex-col" style="border:2px solid var(--g0);padding:6px;flex:1;">
                <div style="font-size:7px;color:var(--g0);margin-bottom:4px;">â–¼ PERPLEXITY</div>
                <div id="ppl-chart" class="flex items-end gap-px flex-grow" style="background:#000;border:1px solid #111;padding:3px;min-height:0;"></div>
                <div style="font-size:5px;color:#444;margin-top:2px;text-align:center;">MUST FALL</div>
            </div>
            <div class="flex flex-col" style="border:2px solid var(--cpu);padding:6px;flex:1;">
                <div style="font-size:7px;color:var(--cpu);margin-bottom:4px;">â–² FITNESS</div>
                <div id="fit-chart" class="flex items-end gap-px flex-grow" style="background:#000;border:1px solid #111;padding:3px;min-height:0;"></div>
                <div style="font-size:5px;color:#444;margin-top:2px;text-align:center;">MUST RISE</div>
            </div>
            <div style="border:2px solid #222;padding:6px;display:flex;flex-direction:column;gap:4px;">
                <div style="font-size:6px;color:#555;display:flex;justify-content:space-between;"><span>KL_DIV</span><span id="s-kl" style="color:#fff;">--</span></div>
                <div style="font-size:6px;color:#555;display:flex;justify-content:space-between;"><span>SPARSITY</span><span id="s-sp" style="color:#fff;">0%</span></div>
                <div style="font-size:6px;color:#555;display:flex;justify-content:space-between;"><span>RANK</span><span id="s-rank" style="color:var(--gld);">--</span></div>
            </div>
        </div>

        <!-- CENTER -->
        <div class="flex flex-col flex-grow gap-2" style="min-width:0;min-height:0;">
            <!-- Viewport -->
            <div id="viewport" class="flex-shrink-0 grid-bg relative overflow-hidden"
                 style="height:220px;border:4px solid #555;background:#000;">
                <div style="position:absolute;inset:0;display:flex;pointer-events:none;">
                    <div style="width:33.3%;border-right:1px dashed #1a1a1a;position:relative;">
                        <span class="zone-lbl" style="left:4px;">GPU0: ORACLE</span>
                    </div>
                    <div style="width:33.3%;position:relative;display:flex;justify-content:center;">
                        <span class="zone-lbl">CPU: RAM</span>
                    </div>
                    <div style="width:33.4%;border-left:1px dashed #1a1a1a;position:relative;display:flex;justify-content:flex-end;">
                        <span class="zone-lbl" style="right:4px;">GPU1: COLISEUM</span>
                    </div>
                </div>
                <div id="sim" style="position:absolute;inset:0;"></div>
            </div>

            <!-- Console -->
            <div class="flex flex-col flex-grow mono" style="border:4px solid var(--g0);background:#000;min-height:0;">
                <div style="border-bottom:1px solid #111;padding:4px 8px;display:flex;justify-content:space-between;">
                    <span style="font-size:7px;color:var(--g0);">// SCIENTIFIC_CONSOLE v2.4</span>
                    <span id="con-phase" style="font-size:7px;color:#444;">IDLE</span>
                </div>
                <div id="con-wrap" class="flex-grow overflow-y-auto" style="padding:8px;min-height:0;">
                    <div id="con-out" style="display:flex;flex-direction:column;gap:6px;">
                        <span style="font-size:11px;color:var(--cpu);">&gt; ROOT_ACCESS GRANTED â€” PRESS [INIT] TO START.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTROLS -->
    <div class="flex-shrink-0 flex items-center gap-4 px-3 py-2 z-10" style="border-top:3px solid #111;">
        <button id="go-btn" class="btn" onclick="GM.next()" style="padding:10px 18px;font-size:9px;">INIT SEQUENCE</button>
        <div style="font-size:7px;color:#444;">PHASE:</div>
        <div style="display:flex;gap:6px;">
            <div id="pd0" style="width:12px;height:12px;border:2px solid #333;background:#111;"></div>
            <div id="pd1" style="width:12px;height:12px;border:2px solid #333;background:#111;"></div>
            <div id="pd2" style="width:12px;height:12px;border:2px solid #333;background:#111;"></div>
            <div id="pd3" style="width:12px;height:12px;border:2px solid #333;background:#111;"></div>
            <div id="pd4" style="width:12px;height:12px;border:2px solid #333;background:#111;"></div>
            <div id="pd5" style="width:12px;height:12px;border:2px solid #333;background:#111;"></div>
        </div>
        <div id="phase-hint" style="font-size:7px;color:#333;">--</div>
    </div>

<script>
'use strict';

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PIXEL SPRITE ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const SPRITES = {
    brain:{rows:[' MMMMM ','MMMMMMM','MPMPMMM','MMMMMMM','MPMPMMM',' MMMMM ','  M  M ','  M  M '],pal:{M:'#bf00ff',P:'#e060ff'}},
    botSmall:{rows:[' CC ','CCCC',' CC ','C  C','C  C'],pal:{C:'#00f5ff'}},
    botElite:{rows:[' GGGG ','GGGGGG','GLLLGG','GGGGGG',' GGGG ','GGGGGG','G    G','G    G'],pal:{G:'#00ff88',L:'#fff'}},
    mecha:{rows:['  WWW  ',' WWWWW ',' WLLWW ',' WWWWW ','WWWWWWW',' WWWWW ',' W   W ',' W   W ','WW   WW'],pal:{W:'#8899bb',L:'#00f5ff'}},
    superBot:{rows:['  GGG  ',' GGGGG ',' GLLGG ',' GGGGG ','GGGGGGG',' GGGGG ',' GGGGG ',' G   G ','GG   GG'],pal:{G:'#ffd700',L:'#fff'}},
    ufo:{rows:['  PPP  ',' PPPPP ','PPPPPPP',' P P P '],pal:{P:'#bf00ff'}},
    crown:{rows:['G G G','GGGGG','GGGGG'],pal:{G:'#ffd700'}},
};
function buildShadow(rows,pal,px){
    const s=[];
    rows.forEach((row,y)=>[...row].forEach((ch,x)=>{ if(ch!==' '&&pal[ch]) s.push(`${x*px}px ${y*px}px 0 0 ${pal[ch]}`); }));
    return s.join(',');
}
function makeSprite(name,px=4,extra=''){
    const sp=SPRITES[name];
    const W=Math.max(...sp.rows.map(r=>r.length))*px, H=sp.rows.length*px;
    const sh=buildShadow(sp.rows,sp.pal,px);
    return `<div style="position:relative;width:${W}px;height:${H}px;overflow:visible;${extra}"><div style="width:${px}px;height:${px}px;box-shadow:${sh};"></div></div>`;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ GAME MANAGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const GM = (() => {
    let stage=-1, busy=false;
    let _ivals=[];

    /* â”€â”€ FIX: charts start empty, fill as stages run â”€â”€ */
    const pplHist   = new Array(6).fill(Infinity);
    const fitHist   = new Array(6).fill(0);
    const pplTarget = [Infinity,154.3,140.1,110.0,80.2,80.2];
    const fitTarget = [0,0.006,0.008,0.010,0.012,0.012];

    const hudData=[
        {vram:'48GB',gen:'00',ppl:Infinity,fit:0,    kl:'--',   sp:'0%', rank:'--'},
        {vram:'14GB',gen:'01',ppl:154.3,   fit:0.006,kl:'âˆ',    sp:'0%', rank:'C' },
        {vram:'14GB',gen:'02',ppl:140.1,   fit:0.008,kl:'0.031',sp:'0%', rank:'C+'},
        {vram:'18GB',gen:'03',ppl:110.0,   fit:0.010,kl:'0.018',sp:'0%', rank:'B' },
        {vram:'18GB',gen:'04',ppl:80.2,    fit:0.012,kl:'0.012',sp:'0%', rank:'S' },
        {vram:'9GB', gen:'05',ppl:80.2,    fit:0.012,kl:'0.012',sp:'50%',rank:'S+'},
    ];

    function $id(id){ return document.getElementById(id); }
    function sim(){ return $id('sim'); }

    /* â”€â”€ FIX: cancel all intervals when clearing scene â”€â”€ */
    function addIval(fn,ms){ const id=setInterval(fn,ms); _ivals.push(id); return id; }
    function clearIvals(){ _ivals.forEach(clearInterval); _ivals=[]; }
    function clearSim(){ clearIvals(); sim().innerHTML=''; }

    function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }

    function setStageLbl(t){
        const el=$id('stage-lbl');
        el.textContent=t;
        el.style.animation='none';
        requestAnimationFrame(()=>el.style.animation='slideInTop .3s ease');
    }

    /* â”€â”€ FIX: updateHUD now feeds chart history â”€â”€ */
    function updateHUD(i){
        const d=hudData[i];
        $id('h-vram').textContent=d.vram;
        $id('h-gen').textContent=d.gen;
        $id('h-ppl').textContent=isFinite(d.ppl)?d.ppl.toFixed(1):'âˆ';
        $id('h-fit').textContent=d.fit.toFixed(3);
        $id('s-kl').textContent=d.kl;
        $id('s-sp').textContent=d.sp;
        $id('s-rank').textContent=d.rank;
        $id('con-phase').textContent=d.gen;
        $id('health-fill').style.width=(40+d.fit/0.012*55)+'%';
        /* push data point for this stage */
        pplHist[i]=pplTarget[i];
        fitHist[i]=fitTarget[i];
        updateCharts();
    }

    function updateDots(i){
        for(let k=0;k<6;k++){
            const el=$id('pd'+k);
            if(k<i){el.style.background='var(--cpu)';el.style.borderColor='var(--cpu)';}
            else if(k===i){el.style.background='var(--gld)';el.style.borderColor='var(--gld)';}
            else{el.style.background='#111';el.style.borderColor='#333';}
        }
    }

    function updateCharts(){
        _renderChart('ppl-chart',pplHist,
            v=>isFinite(v)?Math.min(1,v/200):1,
            v=>isFinite(v)?Math.round(v):'âˆ',
            v=>{const r=isFinite(v)?v/200:1; return r>.65?'#ff0055':r>.35?'#ffd700':'#00ff88';});
        _renderChart('fit-chart',fitHist,
            v=>v/0.013,
            v=>v.toFixed(3),
            v=>v<0.005?'#ff0055':v<0.01?'#ffd700':'#00ff88');
    }
    function _renderChart(id,data,normFn,lblFn,colFn){
        const el=$id(id); if(!el) return;
        const mH=el.offsetHeight||70;
        el.innerHTML='';
        data.forEach(v=>{
            const frac=Math.min(1,Math.max(0,normFn(v)));
            const h=Math.max(1,Math.floor(frac*mH));
            const c=colFn(v);
            el.innerHTML+=`<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:${mH}px;">` +
                `<div style="width:100%;height:${h}px;background:${c};transition:height 1.2s;"></div>` +
                `<div style="font-size:4px;color:#444;margin-top:1px;">${lblFn(v)}</div></div>`;
        });
    }

    /* console */
    async function log(html,cls='',delay=90){
        await wait(delay);
        const line=document.createElement('div');
        line.style.cssText='font-size:11px;line-height:1.6;color:#aaa;';
        if(cls) line.className=cls;
        line.innerHTML=`<span style="color:#333;margin-right:4px;">â€º</span>${html}`;
        $id('con-out').appendChild(line);
        $id('con-wrap').scrollTop=9e9;
        if(window.MathJax?.typesetPromise) await window.MathJax.typesetPromise([line]);
    }
    async function logH(text){
        await wait(60);
        const line=document.createElement('div');
        line.style.cssText='font-size:10px;color:var(--g1);border-top:1px solid #111;padding-top:6px;margin-top:2px;';
        line.textContent='â•â• '+text+' â•â•';
        $id('con-out').appendChild(line);
        $id('con-wrap').scrollTop=9e9;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STAGE 0 â€” ASYNC DISTILLATION
       "La Lluvia de Orbes y los Recolectores"
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function stage0(){
        clearSim(); setStageLbl('FASE 1: DARK KNOWLEDGE'); updateHUD(0); updateDots(0);
        const s=sim();
        s.innerHTML=`
        <!-- brain tank -->
        <div id="tank" style="position:absolute;left:5%;top:8%;width:25%;height:80%;
             border:3px solid #444;background:rgba(0,6,0,.9);">
            <div class="lbl" style="position:absolute;top:3px;left:50%;transform:translateX(-50%);">ORACLE_TANK</div>
            <div id="liq" style="position:absolute;bottom:0;left:0;right:0;height:55%;
                 background:rgba(0,255,40,.06);border-top:1px solid rgba(0,255,80,.2);
                 animation:liquidRise 2s ease-in-out infinite;"></div>
            <div id="brn" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
                 animation:brainPulse 2s ease-in-out infinite;">
                ${makeSprite('brain',5)}
            </div>
        </div>
        <!-- stream label -->
        <div class="lbl" style="position:absolute;left:33%;top:5%;right:0;text-align:center;">â† TOP-K KNOWLEDGE STREAM â†’</div>
        <!-- robot track -->
        <div id="bot-track" style="position:absolute;left:33%;right:0;top:70%;height:32px;"></div>
        <!-- KL badge -->
        <div class="lbl" style="position:absolute;right:4%;top:10%;color:var(--g1);">T=4.0 // TOP-K KL</div>
        <!-- catch zone marker -->
        <div style="position:absolute;left:65%;top:62%;width:2px;height:26px;background:rgba(0,245,255,.15);"></div>`;

        /* spawn 2 robots with baskets */
        ['#00f5ff','#00ff88'].forEach((col,i)=>{
            const bot=document.createElement('div');
            bot.style.cssText=`position:absolute;animation:robotRun ${3.0+i*1.4}s ${i*1.5}s linear infinite;`;
            bot.innerHTML=makeSprite('botSmall',4)+
                `<div id="bask-${i}" class="bot-basket" style="position:absolute;top:-10px;left:3px;width:16px;height:10px;
                 border:2px solid ${col};border-bottom:none;transition:background .15s,box-shadow .15s;"></div>`;
            $id('bot-track').appendChild(bot);
        });

        /* FIX: continuous orb spawning via interval (cleared when stage ends) */
        const orbColors=['#bf00ff','#00f5ff','#ffd700','#ff6699','#00ff88','#ff9900'];
        let oIdx=0;
        addIval(()=>{
            const isTrash=Math.random()<.27;
            const topPct=12+Math.random()*52;
            const dur=0.85+Math.random()*.55;
            const col=orbColors[oIdx++%orbColors.length];
            const sz=isTrash?5:11;
            const o=document.createElement('div');
            o.style.cssText=`position:absolute;width:${sz}px;height:${sz}px;border-radius:50%;
                background:${isTrash?'#333':col};
                box-shadow:${isTrash?'none':'0 0 8px '+col+', 0 0 16px '+col};
                left:26%;top:${topPct}%;
                animation:${isTrash?'trashAway':'orbArc'} ${dur}s ease forwards;z-index:3;`;
            s.appendChild(o);
            /* FIX: basket catch flash when orb arrives */
            if(!isTrash){
                setTimeout(()=>{
                    const baskets=s.querySelectorAll('.bot-basket');
                    if(!baskets.length) return;
                    const b=baskets[Math.floor(Math.random()*baskets.length)];
                    b.style.background=col;
                    b.style.boxShadow=`0 0 14px ${col}, 0 0 28px ${col}`;
                    setTimeout(()=>{ b.style.background='transparent'; b.style.boxShadow='none'; },220);
                    /* tiny absorption burst */
                    const burst=document.createElement('div');
                    burst.style.cssText=`position:absolute;width:18px;height:18px;border-radius:50%;
                        background:${col};opacity:.7;left:65%;top:66%;
                        animation:orbCatch .35s ease forwards;`;
                    s.appendChild(burst);
                    setTimeout(()=>burst.remove(),400);
                }, dur*1000*.82);
            }
            setTimeout(()=>o.remove(),(dur+.4)*1000);
        },340);

        await logH('FASE 1 â€” DARK KNOWLEDGE EXTRACTION');
        await log('Iniciando <code>AsyncOllamaTeacher</code>: conexiÃ³n al 70B Oracle via aiohttp concurrent I/O.','',0);
        await log('El OrÃ¡culo dispara distribuciones de probabilidad suaves â€” <b>Dark Knowledge</b>.','',200);
        await log('âš  Vocabulario: 151,000 dimensiones. Solo el Top-K tiene seÃ±al; el resto es <span style="color:var(--alt);">ruido blanco</span>.','',200);
        await log('Los Robots Recolectores capturan orbes brillantes y descartan la basura gris.','',200);
        await log('Aplicando <b>MÃ¡scara TopolÃ³gica Top-K</b> + Temperatura $T=4.0$:','',200);
        await log('$$ \\mathcal{L}_{KD} = T^2 \\cdot \\frac{1}{|K|} \\sum_{i \\in K} P_i \\!\\left(\\log P_i - \\log Q_i\\right) $$','',300);
        await log('Gradientes fluyendo limpiamente sin ruido blanco de vocabulario.','',300);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STAGE 1 â€” LoRA GENOME
       "El Mecha Congelado y los Jetpacks"
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function stage1(){
        clearSim(); setStageLbl('FASE 2: LoRA GENOME'); updateHUD(1); updateDots(1);
        const s=sim();

        /* â”€â”€ Drone + B + A all start at the RIGHT as separate elements
              that move together via JS (same transition timing) â”€â”€ */
        s.innerHTML=`
        <!-- FROZEN MECHA -->
        <div id="mw" style="position:absolute;left:14%;top:8%;animation:mechaIdle 2.5s ease-in-out infinite;">
            ${makeSprite('mecha',9)}
            <div class="lbl" style="position:absolute;top:-16px;left:0;">Wâ‚€: 3.4 GB [FROZEN]</div>
            <div id="slot-b" style="position:absolute;left:4px;top:44px;width:20px;height:28px;
                 border:2px dashed rgba(191,0,255,.35);background:rgba(191,0,255,.04);"></div>
            <div id="slot-a" style="position:absolute;right:3px;top:44px;width:20px;height:28px;
                 border:2px dashed rgba(0,245,255,.35);background:rgba(0,245,255,.04);"></div>
        </div>
        <!-- LOCK -->
        <div id="lck" style="position:absolute;left:15%;top:6%;font-size:24px;opacity:0;transition:opacity .4s;">ğŸ”’</div>

        <!-- DRONE body â€” moves independently, same timing as matrices -->
        <div id="drone-e" style="position:absolute;left:70%;top:6%;
             animation:droneHover 1.1s ease-in-out infinite;
             transition:left 2.8s ease,top 2.8s ease;">
            <div style="position:absolute;top:-6px;left:-5px;width:13px;height:3px;
                 background:rgba(0,245,255,.75);animation:propSpin .09s linear infinite;"></div>
            <div style="position:absolute;top:-6px;right:-5px;width:13px;height:3px;
                 background:rgba(0,245,255,.75);animation:propSpin .09s .05s linear infinite;"></div>
            <div style="width:38px;height:18px;background:rgba(0,245,255,.12);border:2px solid var(--g1);
                 display:flex;align-items:center;justify-content:center;">
                <span id="drone-lbl" style="font-size:5px;color:var(--g1);">DRONE</span></div>
            <div class="lbl" style="position:absolute;top:-20px;left:50%;transform:translateX(-50%);">ADAPTER DRONE</div>
            <!-- hanging cable B -->
            <div id="cable-b" style="position:absolute;left:6px;top:18px;width:2px;height:16px;background:rgba(191,0,255,.5);"></div>
            <!-- hanging cable A -->
            <div id="cable-a" style="position:absolute;right:6px;top:18px;width:2px;height:16px;background:rgba(0,245,255,.5);"></div>
        </div>

        <!-- B matrix â€” starts hanging below drone, moves with same transition -->
        <div id="box-b" style="position:absolute;left:67%;top:26%;
             width:22px;height:32px;background:rgba(191,0,255,.88);
             border:2px solid #ff00ff;box-shadow:0 0 12px var(--g0);
             display:flex;flex-direction:column;align-items:center;justify-content:center;
             transition:left 2.8s ease,top 2.8s ease,opacity .6s ease;z-index:10;">
            <div style="font-size:7px;color:#fff;font-weight:bold;">B</div>
            <div style="font-size:4px;color:rgba(255,255,255,.7);">dÃ—r</div>
        </div>
        <!-- A matrix -->
        <div id="box-a" style="position:absolute;left:73%;top:26%;
             width:22px;height:32px;background:rgba(0,245,255,.88);
             border:2px solid #00f5ff;box-shadow:0 0 12px var(--g1);
             display:flex;flex-direction:column;align-items:center;justify-content:center;
             transition:left 2.8s ease,top 2.8s ease,opacity .6s ease;z-index:10;">
            <div style="font-size:7px;color:#000;font-weight:bold;">A</div>
            <div style="font-size:4px;color:rgba(0,0,0,.7);">rÃ—k</div>
        </div>

        <!-- LoRA badge (hidden) -->
        <div id="lora-eq" style="display:none;position:absolute;right:4%;top:10%;
             border:2px solid var(--gld);padding:7px;background:rgba(0,0,0,.9);">
            <div style="font-size:7px;color:var(--gld);">RANK-16 ACTIVE âœ“</div>
            <div style="font-size:7px;color:var(--cpu);margin-top:5px;">25 MB â† 3.4 GB</div>
            <div style="font-size:6px;color:#555;margin-top:3px;">ADN listo para clonar</div>
        </div>
        <!-- DNA chip (hidden, materialises after awakening) -->
        <div id="dna-chip" style="display:none;position:absolute;left:18%;top:38%;
             width:34px;height:18px;background:var(--gld);border:2px solid #fff;
             box-shadow:0 0 12px var(--gld);font-size:5px;color:#000;
             align-items:center;justify-content:center;">ADN 25MB</div>`;

        /* lock drops */
        await wait(400);
        $id('lck').style.opacity='1';

        /* â”€â”€ Drone + matrices fly LEFT together (same 2.8s transition) â”€â”€ */
        await wait(1400);
        /* delivery position: drone above mecha, matrices hanging just above mecha slots */
        $id('drone-e').style.left='16%';  $id('drone-e').style.top='4%';
        $id('box-b').style.left='14%';    $id('box-b').style.top='24%';
        $id('box-a').style.left='20%';    $id('box-a').style.top='24%';

        /* â”€â”€ Matrices slot into mecha (slide down into slots) â”€â”€ */
        await wait(3000);
        $id('box-b').style.top='32%';
        $id('box-a').style.top='32%';
        /* hide cables now */
        ['cable-b','cable-a'].forEach(id=>{ const el=$id(id); if(el) el.style.opacity='0'; });

        await wait(800);
        /* slots glow */
        const sB=$id('slot-b'), sA=$id('slot-a');
        if(sB){ sB.style.background='rgba(191,0,255,.5)'; sB.style.boxShadow='inset 0 0 12px var(--g0)'; sB.style.borderColor='#ff00ff'; }
        if(sA){ sA.style.background='rgba(0,245,255,.5)'; sA.style.boxShadow='inset 0 0 12px var(--g1)'; sA.style.borderColor='#00f5ff'; }
        /* hide matrices (slotted in) */
        $id('box-b').style.opacity='0'; $id('box-a').style.opacity='0';

        $id('lck').style.opacity='0';
        const mecha=$id('mw');
        if(mecha) mecha.style.animation='mechaAwaken 2.5s forwards';

        /* â”€â”€ DNA chip appears â†’ drone picks it up â†’ drone flies right with ADN â”€â”€ */
        await wait(1400);
        const chip=$id('dna-chip');
        chip.style.display='flex';
        await wait(700);
        chip.style.display='none';
        /* drone moves back right, now labeled with ADN */
        const dl=$id('drone-lbl');
        if(dl) dl.textContent='ADN âœ“';
        $id('drone-e').style.left='68%';
        $id('drone-e').style.top='6%';
        $id('lora-eq').style.display='block';

        await logH('FASE 2 â€” DIMENSIONALIDAD INTRÃNSECA (LoRA)');
        await log('Congelando $W_0 \\in \\mathbb{R}^{d \\times k}$ â€” 1.7B parÃ¡metros, inmÃ³vil.','',0);
        await log('El Drone transporta <b>B</b> (magenta, $d\\!\\times\\!r$) y <b>A</b> (cyan, $r\\!\\times\\!k$) hacia el Mecha.','',200);
        await log('Las matrices descienden a los <b>slots del torso</b> â€” el ADN puede moverse:','',200);
        await log('$$ W_{\\text{eff}} = W_0 + \\tfrac{\\alpha}{r} \\underbrace{B}_{d\\times r}\\,\\underbrace{A}_{r\\times k} $$','',300);
        await log('ParÃ¡metros entrenables: <span style="color:var(--cpu);">25 MB</span> vs 3.4 GB â€” 99.3% menos.','',300);
        await log('Mecha levitando. El Drone recoge el ADN (25 MB) y lo lleva a la FÃ¡brica de Clones.','',500);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STAGE 2 â€” CLONE FACTORY
       "La FÃ¡brica de Clones y el Rayo Radiactivo"
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function stage2(){
        clearSim(); setStageLbl('FASE 3: MUTATION'); updateHUD(2); updateDots(2);
        const s=sim();
        s.innerHTML=`
        <!-- conveyor -->
        <div style="position:absolute;left:0;right:0;top:60%;height:24px;
             background:repeating-linear-gradient(90deg,#2a2a2a 0,#2a2a2a 14px,#444 14px,#444 20px);
             animation:conveyorScroll .5s linear infinite;"></div>
        <div style="position:absolute;left:0;right:0;top:58%;height:3px;background:#666;"></div>
        <div style="position:absolute;left:0;right:0;top:84%;height:3px;background:#666;"></div>
        <div style="position:absolute;left:2%;top:60%;width:20px;height:24px;border-radius:50%;background:#777;border:2px solid #aaa;"></div>
        <div style="position:absolute;right:2%;top:60%;width:20px;height:24px;border-radius:50%;background:#777;border:2px solid #aaa;"></div>

        <!-- UFO mutator -->
        <div id="ufo-w" style="position:absolute;left:50%;top:10%;animation:ufoHover 1.6s ease-in-out infinite;">
            ${makeSprite('ufo',5)}
            <div class="lbl" style="position:absolute;top:-16px;left:50%;transform:translateX(-50%);">MUTATOR v3.1</div>
        </div>

        <!-- PERSISTENT laser beam (always on, full height from UFO to conveyor) -->
        <div id="laser" style="position:absolute;left:50%;top:34%;width:5px;height:28%;
             transform:translateX(-50%);
             background:linear-gradient(to bottom,var(--g0),rgba(191,0,255,.15));
             box-shadow:0 0 14px var(--g0),0 0 28px rgba(191,0,255,.45);
             transition:box-shadow .25s;"></div>

        <!-- RAM badge -->
        <div class="lbl" style="position:absolute;right:4%;top:5%;color:var(--cpu);">RAM POOL: 6 GENOMES</div>
        <!-- legend -->
        <div style="position:absolute;left:4%;top:5%;display:flex;gap:8px;align-items:center;">
            <div style="width:10px;height:10px;border-radius:50%;background:var(--cpu);box-shadow:0 0 6px var(--cpu);"></div>
            <span class="lbl">ORIGINAL (sin mutar)</span>
            <div style="width:10px;height:10px;border-radius:50%;background:#ff6699;box-shadow:0 0 6px #ff6699;margin-left:6px;"></div>
            <span class="lbl">MUTADO</span>
        </div>
        <!-- clone track -->
        <div id="ct" style="position:absolute;left:0;right:0;top:51%;height:30px;"></div>`;

        /* â”€â”€ Clone spawning: JS-driven so each clone ALWAYS starts green â”€â”€
           Clones travel from left:-15% to right:112%.
           The laser sits at viewport left:50%.
           Journey fraction when crossing laser = (50-(-15))/(112-(-15)) â‰ˆ 51%.
           We fire the mutation callback at that exact moment.           â”€â”€ */
        const MUT_COLS=['#ff6699','#bf00ff','#ffd700','#00f5ff','#ff9900','#ff3355'];
        let mutIdx=0, cloneIdx=0;

        function spawnClone(){
            const track=$id('ct'); if(!track) return;
            const num=(cloneIdx++%6)+1;
            const dur=2800+Math.random()*700;  // ms to cross full width
            const clone=document.createElement('div');
            clone.style.cssText=`position:absolute;left:-15%;top:0;transition:left ${dur}ms linear;`;
            clone.innerHTML=`<div class="clone-inner" style="width:22px;height:22px;
                background:#00ff88;border-radius:50%;border:2px solid #fff;
                box-shadow:0 0 8px #00ff88;display:flex;align-items:center;justify-content:center;">
                <span style="font-size:5px;color:#000;">${num}</span></div>`;
            track.appendChild(clone);

            /* start moving on next frame */
            requestAnimationFrame(()=>requestAnimationFrame(()=>{ clone.style.left='112%'; }));

            /* mutate exactly when crossing the laser (51% of travel time) */
            if(Math.random()>.28){   /* 72% chance of mutation */
                setTimeout(()=>{
                    const inner=clone.querySelector('.clone-inner');
                    if(!inner||!clone.isConnected) return;
                    clone.classList.add('glitching');
                    /* flash the laser brighter on hit */
                    const laser=$id('laser');
                    if(laser){
                        laser.style.boxShadow='0 0 28px var(--g0),0 0 56px rgba(191,0,255,.9)';
                        setTimeout(()=>{ if(laser) laser.style.boxShadow='0 0 14px var(--g0),0 0 28px rgba(191,0,255,.45)'; },320);
                    }
                    setTimeout(()=>{
                        clone.classList.remove('glitching');
                        const mc=MUT_COLS[mutIdx++%MUT_COLS.length];
                        inner.style.background=mc;
                        inner.style.boxShadow=`0 0 10px ${mc}`;
                        inner.style.borderColor=mc;
                        const sp=inner.querySelector('span');
                        if(sp) sp.style.color='#fff';
                    },370);
                }, dur*0.51);
            }

            /* remove clone after it exits right */
            setTimeout(()=>{ if(clone.isConnected) clone.remove(); }, dur+500);
        }

        /* spawn continuously while stage is active */
        addIval(spawnClone, 650);

        await logH('FASE 3 â€” CLONACIÃ“N & MUTACIÃ“N GAUSSIANA');
        await log('El Drone deposita el ADN (25 MB) en CPU RAM. <b>Clonando Ã— 6</b> â€” todos idÃ©nticos (verde).','',0);
        await log('Los clones pasan por la cinta. El Rayo del Mutator es <b>persistente y siempre activo</b>.','',200);
        await log('Al atravesar el rayo, el clon recibe ruido gaussiano y cambia de color:','',200);
        await log('$$ W_{\\text{mut}} = W_{\\text{elite}} + \\mathcal{N}(0,\\, \\sigma^2 I) $$','',300);
        await log('Verde = sin mutar. Otro color = mutado. El rayo brilla mÃ¡s en cada impacto.','',300);
        await log('Resultado: poblaciÃ³n diversa de 6 genomas. Enviando al Coliseo...','',400);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STAGE 3 â€” LAMARCKISM / GYM
       "El Gimnasio de Levantamiento de Pesas"
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function stage3(){
        clearSim(); setStageLbl('FASE 4: LAMARCKISM'); updateHUD(3); updateDots(3);
        const s=sim();
        s.innerHTML=`
        <div class="lbl" style="position:absolute;left:34%;top:4%;color:var(--g1);">GPU1: THE GYM â€” memetic_steps=5</div>
        <div style="position:absolute;left:33%;right:0;bottom:20%;height:2px;background:#2a2a2a;"></div>
        <div class="lbl" style="position:absolute;left:2%;top:5%;color:var(--cpu);">CPU QUEUE</div>
        <div id="cpu-q" style="position:absolute;left:2%;top:18%;display:flex;flex-direction:column;gap:5px;"></div>
        <div id="athletes" style="position:absolute;left:34%;right:2%;top:10%;bottom:20%;
             display:flex;align-items:flex-end;justify-content:space-around;"></div>
        <div id="step-ctr" style="position:absolute;right:4%;top:4%;font-size:8px;color:var(--g1);background:rgba(0,0,0,.7);padding:2px 5px;">STEP 0/5</div>
        <div id="fitness-row" style="position:absolute;bottom:4%;left:34%;right:2%;display:flex;justify-content:space-around;"></div>`;

        /* CPU queue */
        const q=$id('cpu-q');
        for(let i=0;i<6;i++){
            const item=document.createElement('div');
            item.style.cssText='display:flex;align-items:center;gap:4px;';
            item.innerHTML=`<div style="width:14px;height:14px;border-radius:50%;background:${i===0?'var(--gld)':'var(--cpu)'};opacity:${i===0?1:.4};"></div>`+
                `<span style="font-size:5px;color:#444;background:rgba(0,0,0,.5);padding:1px 3px;">IND_0${i}</span>`;
            q.appendChild(item);
        }

        /* FIX: 6 athletes that visually grow each step */
        const ATH_COLS=['#ffd700','#00ff88','#00f5ff','#ff9900','#ff6699','#bf00ff'];
        const RANKS=['S+','S','A','A-','B','C'];
        const RANK_COLS=['#ffd700','#ffd700','#00ff88','#00ff88','#00f5ff','#ff0055'];
        const athArea=$id('athletes');

        for(let i=0;i<6;i++){
            const ath=document.createElement('div');
            ath.id=`ath-${i}`;
            ath.style.cssText=`position:relative;display:flex;flex-direction:column;align-items:center;flex:1;
                transform:scale(.6);transform-origin:bottom center;
                transition:transform .55s ease,filter .55s ease;
                filter:brightness(.7) drop-shadow(0 0 3px ${ATH_COLS[i]});`;
            ath.innerHTML=
                `<div id="rk-${i}" style="display:none;position:absolute;top:-28px;font-size:16px;
                 color:${RANK_COLS[i]};animation:rankFlash .5s infinite;">${RANKS[i]}</div>`+
                `<div class="ath-head" style="width:14px;height:10px;background:${ATH_COLS[i]};border:2px solid #fff;margin-bottom:1px;"></div>`+
                `<div class="ath-body" style="width:18px;height:26px;background:${ATH_COLS[i]};border:2px solid #fff;position:relative;
                 animation:weightLift ${.52+i*.07}s ease-in-out infinite alternate;">
                    <div class="sw" style="position:absolute;top:2px;right:-7px;width:4px;height:6px;
                         background:#55aaff;border-radius:50% 50% 50% 0;animation:sweatDrop .7s ${i*.2}s infinite;"></div>
                </div>`+
                `<div class="ath-bar" style="position:relative;width:34px;height:6px;background:#888;margin-top:2px;
                 animation:weightLift ${.52+i*.07}s ease-in-out infinite alternate;">
                    <div style="position:absolute;left:-4px;width:8px;height:12px;background:#aaa;top:-3px;"></div>
                    <div style="position:absolute;right:-4px;width:8px;height:12px;background:#aaa;top:-3px;"></div>
                    <div class="lbl" style="position:absolute;top:-11px;left:50%;transform:translateX(-50%);padding:0 2px;">DATA</div>
                </div>`;
            athArea.appendChild(ath);
        }

        /* FIX: progressive visual growth per training step */
        const SCALES=[.6,.73,.86,1.0,1.15,1.35];
        const GLOWS=[3,7,13,21,30,42];
        let step=0;
        addIval(()=>{
            if(step>=5){ clearIvals(); return; }
            step++;
            $id('step-ctr').textContent=`STEP ${step}/5`;
            const sc=SCALES[step], gl=GLOWS[step];
            for(let i=0;i<6;i++){
                const a=$id(`ath-${i}`); if(!a) continue;
                a.style.transform=`scale(${sc})`;
                a.style.filter=`brightness(${.7+step*.12}) drop-shadow(0 0 ${gl}px ${ATH_COLS[i]})`;
            }
            /* show ranks at final step */
            if(step===5){
                for(let i=0;i<6;i++){
                    const rk=$id(`rk-${i}`); if(rk) rk.style.display='block';
                }
                /* eliminate weakest (last) */
                setTimeout(()=>{
                    const last=$id('ath-5');
                    if(last){last.style.transition='opacity .5s,transform .5s';last.style.opacity='0';last.style.transform='scale(.3) translateY(40px)';}
                },800);
                /* fitness labels */
                const fr=$id('fitness-row');
                if(fr){
                    fr.innerHTML='';
                    [.012,.011,.010,.009,.007,'X'].forEach(v=>{
                        const el=document.createElement('div');
                        el.style.cssText='flex:1;text-align:center;';
                        el.innerHTML=`<div class="lbl" style="display:inline-block;color:${v==='X'?'var(--alt)':'var(--cpu)'};">FIT:${v}</div>`;
                        fr.appendChild(el);
                    });
                }
            }
        },720);

        await logH('FASE 4 â€” EVOLUCIÃ“N MEMÃ‰TICA (LAMARCKISMO)');
        await log('Los 6 individuos aprenden <b>en vida</b> antes de ser evaluados â€” <code>memetic_steps=5</code>.','',0);
        await log('Observa cÃ³mo <b>crecen y se hacen mÃ¡s fuertes</b> con cada paso de entrenamiento.','',200);
        await log('AdamW ejecutado en cada genoma individualmente en GPU1:','',200);
        await log('$$ \\theta_{t+1} = \\theta_t - \\eta \\cdot \\frac{\\hat{m}_t}{\\sqrt{\\hat{v}_t}+\\varepsilon} - \\lambda\\,\\theta_t $$','',300);
        await log('Lamarck tenÃ­a razÃ³n aquÃ­: los pesos mejorados se <b>heredan directamente al ADN</b>.','',300);
        await log('Fitness = $1/(1+\\text{PPL})$. Ranking asignado. El mÃ¡s dÃ©bil cae por la trampilla.','',400);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STAGE 4 â€” TIES-MERGING
       "La FusiÃ³n QuirÃºrgica DBZ"
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function stage4(){
        clearSim(); setStageLbl('FASE 5: TIES MERGE'); updateHUD(4); updateDots(4);
        const s=sim();
        s.innerHTML=`
        <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
             width:75%;height:85%;border:2px dashed #1a1a1a;border-radius:50%;"></div>
        <div class="lbl" style="position:absolute;left:50%;top:4%;transform:translateX(-50%);color:var(--gld);">TIES FUSION CHAMBER (Yadav et al. 2023)</div>
        <!-- Parent 1 -->
        <div id="p1" style="position:absolute;left:8%;top:20%;transition:left 1.6s ease,opacity 1.6s ease;">
            ${makeSprite('botElite',6)}
            <div class="lbl" style="text-align:center;margin-top:3px;color:var(--cpu);">ELITE_1</div>
            <div id="au1" style="position:absolute;inset:-6px;border-radius:6px;
                 box-shadow:0 0 18px var(--cpu);animation:auraGlow 1.2s infinite;"></div>
        </div>
        <!-- Parent 2 -->
        <div id="p2" style="position:absolute;right:8%;top:20%;transition:right 1.6s ease,opacity 1.6s ease;">
            <div style="filter:hue-rotate(200deg);">${makeSprite('botElite',6)}</div>
            <div class="lbl" style="text-align:center;margin-top:3px;color:var(--g1);">ELITE_2</div>
            <div id="au2" style="position:absolute;inset:-6px;border-radius:6px;
                 box-shadow:0 0 18px var(--g1);animation:auraGlow 1.2s .4s infinite;"></div>
        </div>
        <!-- step label -->
        <div id="slbl" style="position:absolute;left:50%;bottom:7%;transform:translateX(-50%);text-align:center;min-width:240px;"></div>
        <!-- saw -->
        <div id="saw" style="display:none;position:absolute;left:50%;top:28%;transform:translateX(-50%);">
            <div style="width:30px;height:30px;border-radius:50%;border:5px solid var(--alt);
                 animation:sawSpin .28s linear infinite;box-shadow:0 0 14px var(--alt);"></div>
        </div>
        <!-- magnet -->
        <div id="mag" style="display:none;position:absolute;left:50%;top:3%;font-size:28px;animation:magnetBob 1s ease-in-out infinite;">ğŸ§²</div>
        <!-- flash -->
        <div id="ff" style="display:none;position:absolute;inset:0;background:#fff;animation:fusionFlash .8s ease forwards;"></div>
        <!-- super bot -->
        <div id="sup" style="display:none;position:absolute;left:50%;top:12%;animation:superIdle 1.5s ease-in-out infinite;">
            ${makeSprite('superBot',8)}
            <div style="position:absolute;top:-16px;left:50%;transform:translateX(-50%);">
                ${makeSprite('crown',5)}
            </div>
            <div style="font-size:8px;color:var(--gld);text-align:center;margin-top:5px;
                 text-shadow:0 0 12px var(--gld);white-space:nowrap;background:rgba(0,0,0,.5);padding:2px 5px;">âœ¦ SUPER-ELITE âœ¦</div>
        </div>`;

        const sl=$id('slbl');
        const setS=html=>{ if(sl) sl.innerHTML=`<div class="lbl" style="display:inline-block;">${html}</div>`; };

        await wait(400);
        setS('<span style="color:var(--alt);">STEP 1: TRIM â€” Poda 80% de pesos dÃ©biles</span>');
        $id('saw').style.display='block';
        for(let i=0;i<12;i++) setTimeout(()=>{
            const sc=document.createElement('div');
            sc.style.cssText=`position:absolute;left:${18+Math.random()*64}%;top:${28+Math.random()*32}%;
                width:4px;height:4px;background:#888;animation:trashAway .9s ease forwards;`;
            s.appendChild(sc); setTimeout(()=>sc.remove(),1000);
        },i*200);

        await wait(2400);
        $id('saw').style.display='none';
        $id('mag').style.display='block';
        setS('<span style="color:var(--gld);">STEP 2: ELECT â€” VotaciÃ³n de signo magnÃ©tico</span>');
        $id('au1').style.boxShadow='0 0 35px var(--gld), 0 0 70px var(--gld)';
        $id('au2').style.boxShadow='0 0 35px var(--gld), 0 0 70px var(--gld)';

        await wait(2200);
        $id('mag').style.display='none';
        setS('<span style="color:var(--cpu);">STEP 3: MERGE â€” FusiÃ³n de sinapsis alineadas</span>');
        const p1=$id('p1'), p2=$id('p2');
        if(p1){p1.style.left='38%'; p1.style.opacity='0';}
        if(p2){p2.style.right='38%'; p2.style.opacity='0';}

        await wait(1700);
        $id('ff').style.display='block';
        await wait(860);
        $id('ff').style.display='none';
        $id('sup').style.display='block';
        setS('<span style="color:var(--gld);">âœ¦ SUPER-ELITE FORJADO â€” PPL: 80.2 âœ¦</span>');

        await logH('FASE 5 â€” TIES-MERGING (Yadav et al. 2023)');
        await log('Promedio lineal: $W=(W_1+W_2)/2$ â†’ <span style="color:var(--alt);">lobotomÃ­a por interferencia de signos</span>.','',0);
        await log('Ejemplo: $+0.5$ (padre) $+\\, (-0.5)$ (madre) $= 0.0$ â†’ neurona aniquilada.','',200);
        await log('<b>STEP 1 â€” TRIM:</b> $W_{\\text{trim}} = W \\odot \\mathbf{1}_{|W|\\ge\\tau}$ (top-20% por magnitud).','',300);
        await log('<b>STEP 2 â€” ELECT:</b> $\\gamma_i = \\operatorname{sgn}\\!\\bigl(\\sum_k W^{(k)}_{\\text{trim},i}\\bigr)$ (voto de direcciÃ³n).','',300);
        await log('<b>STEP 3 â€” MERGE:</b> promediar solo sinapsis que apuntan a la misma verdad.','',300);
        await log('Sin aniquilaciÃ³n. El Super-Elite hereda lo mejor de ambos padres.','',400);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STAGE 5 â€” 2:4 SPARSITY
       "La Prensa de Silicio y el Modo Turbo"
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function stage5(){
        clearSim(); setStageLbl('FASE 6: 2:4 SPARSITY'); updateHUD(5); updateDots(5);
        const s=sim();

        /* build 8Ã—4 grid cells */
        let gc='';
        for(let i=0;i<32;i++) gc+=`<div id="gc-${i}" style="background:var(--cpu);border:1px solid #000;transition:all .45s;"></div>`;

        s.innerHTML=`
        <!-- SUPER-BOT enters from left -->
        <div id="sb-enter" style="position:absolute;left:50%;top:8%;transform:translateX(-50%);
             transition:filter 1.5s ease,transform 2s ease;">
            ${makeSprite('superBot',7)}
            <div style="position:absolute;top:-16px;left:50%;transform:translateX(-50%);">
                ${makeSprite('crown',4)}
            </div>
            <div class="lbl" style="text-align:center;margin-top:4px;color:var(--gld);">SUPER-ELITE</div>
        </div>

        <!-- BODY SCAN grid overlay (on bot body) -->
        <div id="body-scan" style="position:absolute;left:50%;top:26%;transform:translateX(-50%);
             width:58px;display:grid;grid-template-columns:repeat(4,1fr);gap:2px;
             padding:4px;border:2px solid rgba(0,245,255,.6);
             background:rgba(0,245,255,.05);opacity:0;transition:opacity .6s;">
            ${gc}
        </div>
        <!-- scan sweep line -->
        <div id="scan-line" style="display:none;position:absolute;left:50%;top:26%;
             transform:translateX(-50%);width:58px;height:2px;
             background:rgba(0,245,255,.8);box-shadow:0 0 8px var(--g1);
             animation:scanLine 1.2s linear forwards;"></div>

        <!-- Hydraulic press -->
        <div id="press" style="position:absolute;left:20%;right:20%;top:0;height:22px;
             background:#444;border:3px solid #888;z-index:6;transition:transform 2.5s ease;">
            <div style="width:26px;height:12px;background:#222;margin:3px auto;border:2px solid var(--alt);"></div>
        </div>

        <!-- MMA badge -->
        <div id="mma" style="position:absolute;left:4%;top:6%;opacity:0;transition:opacity 1s;">
            <div style="animation:hwFlash .28s infinite;padding:4px 6px;border:1px solid var(--cpu);">
                <div style="font-size:7px;">mma.sp.sync âœ“</div>
                <div style="font-size:5px;color:#000;">TENSOR CORE NATIVE</div>
            </div>
        </div>

        <!-- speed lines container -->
        <div id="slines" style="display:none;position:absolute;inset:0;overflow:hidden;pointer-events:none;"></div>

        <!-- zooming bot (hidden) -->
        <div id="s-zoom" style="display:none;position:absolute;top:42%;transform:translateY(-50%);
             animation:robotZoom 1.8s linear forwards;">
            ${makeSprite('superBot',5)}
            <div style="font-size:8px;color:var(--gld);white-space:nowrap;
                 animation:deployPulse .7s infinite;text-align:center;">2Ã— SPEED</div>
        </div>

        <!-- BEFORE / AFTER label -->
        <div id="ba-lbl" style="display:none;position:absolute;left:4%;bottom:5%;">
            <div class="lbl" style="color:var(--alt);">BEFORE: 48GB VRAM</div>
            <div class="lbl" style="color:var(--cpu);margin-top:3px;">AFTER: 24GB Â· 2Ã— faster</div>
        </div>

        <!-- deploy text -->
        <div id="deploy" style="display:none;position:absolute;left:50%;bottom:4%;transform:translateX(-50%);text-align:center;white-space:nowrap;">
            <div style="font-size:11px;color:var(--cpu);animation:deployPulse .65s infinite;">âœ¦ DEPLOYMENT READY âœ¦</div>
            <div style="font-size:6px;color:#555;margin-top:3px;">50% VRAM Â· 2Ã— THROUGHPUT Â· ZERO OVERHEAD</div>
        </div>`;

        /* body scan appears */
        await wait(700);
        $id('scan-line').style.display='block';
        await wait(800);
        $id('body-scan').style.opacity='1';

        /* FIX: apply 2:4 pattern row by row on the SUPER-BOT's body */
        await wait(600);
        for(let row=0;row<8;row++){
            await wait(130);
            const all=[0,1,2,3];
            const a=all.splice(Math.floor(Math.random()*4),1)[0];
            const b=all.splice(Math.floor(Math.random()*3),1)[0];
            for(let col=0;col<4;col++){
                const cell=$id(`gc-${row*4+col}`);
                if(!cell) continue;
                if(col===a||col===b){
                    cell.style.background='#0a0a0f';
                    cell.style.boxShadow='inset 0 0 4px #000';
                } else {
                    cell.style.boxShadow='0 0 7px var(--cpu)';
                }
            }
        }

        /* press comes down, bot compresses */
        await wait(800);
        $id('press').style.transform='translateY(35px)';
        const sbEnter=$id('sb-enter');
        if(sbEnter){
            sbEnter.style.transform='translateX(-50%) scale(.55)';
            sbEnter.style.filter='brightness(2) drop-shadow(0 0 30px var(--gld))';
        }
        $id('ba-lbl').style.display='block';

        /* MMA badge */
        await wait(1000);
        $id('mma').style.opacity='1';

        /* speed lines + zoom */
        await wait(900);
        const sl=$id('slines');
        sl.style.display='block';
        for(let i=0;i<14;i++){
            const ln=document.createElement('div');
            const tp=6+Math.random()*82;
            ln.style.cssText=`position:absolute;top:${tp}%;right:0;height:2px;
                width:${22+Math.random()*44}%;
                background:linear-gradient(to left,transparent,rgba(0,245,255,.7));
                animation:speedLine ${.32+Math.random()*.32}s ${i*.07}s linear infinite;`;
            sl.appendChild(ln);
        }
        $id('body-scan').style.opacity='0';
        if(sbEnter) sbEnter.style.display='none';
        $id('s-zoom').style.display='block';

        await wait(1000);
        $id('deploy').style.display='block';

        await logH('FASE 6 â€” NVIDIA 2:4 SEMI-STRUCTURED SPARSITY');
        await log('El Super-Elite entra a la Prensa. Iniciando <b>Body Scan</b> con rayos X.','',0);
        await log('RestricciÃ³n de Tensor Core: exactamente <b>2 pesos no-cero</b> por cada bloque de 4.','',200);
        await log('$\\|w_{4i:4i+3}\\|_0 \\le 2$ â€” La cuadrÃ­cula muestra en rojo los pesos podados.','',300);
        await log('<b>Algoritmo magnitude-based</b>: los 2 de menor magnitud son puestos a cero.','',300);
        await log('<code>to_sparse_semi_structured(w_masked)</code> â€” compresiÃ³n fÃ­sica PTX.','',300);
        await log('<span style="color:var(--cpu);">RESULTADO: 50% VRAM Â· 2Ã— throughput Â· zero software overhead.</span>','',400);
        await log('<span style="color:var(--gld);font-size:12px;">âœ¦ GÃ‰NESIS PIPELINE COMPLETADO. MODELO LISTO PARA PRODUCCIÃ“N. âœ¦</span>','',500);
    }

    /* â”€â”€â”€â”€ PUBLIC â”€â”€â”€â”€ */
    const runners=[stage0,stage1,stage2,stage3,stage4,stage5];
    const nextLbls=['NEXT: LoRA GENOME Â»','NEXT: MUTATION Â»','NEXT: LAMARCKISM Â»','NEXT: TIES-MERGE Â»','NEXT: 2:4 SPARSITY Â»','â†º RESTART SYSTEM'];
    const hints=['ASYNC DISTILLATION','LoRA GENOME','CLONE FACTORY','GYM / LAMARCK','TIES FUSION','SILICON PRESS'];

    async function next(){
        if(busy) return;
        busy=true;
        const btn=$id('go-btn');
        btn.disabled=true; btn.textContent='EXECUTING...';

        stage=(stage+1)%runners.length;
        if(stage===0){
            $id('con-out').innerHTML='<span style="font-size:11px;color:var(--cpu);">&gt; SYSTEM RESET â€” RESTARTING GENESIS PIPELINE...</span>';
            /* reset chart data */
            for(let i=0;i<6;i++){ pplHist[i]=Infinity; fitHist[i]=0; }
            updateCharts();
        }
        $id('phase-hint').textContent=hints[stage];
        await runners[stage]();

        btn.disabled=false; btn.textContent=nextLbls[stage]; busy=false;
    }

    return { next, init(){ updateCharts(); } };
})();

window.addEventListener('DOMContentLoaded',()=>GM.init());
</script>
</body>
</html>
